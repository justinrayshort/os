name: Quarterly Documentation Audit

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 1 */3 *"

permissions:
  contents: read

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install docs build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material pymdown-extensions

      - name: Install docs validation CLIs
        run: |
          npm install -g markdownlint-cli2 @apidevtools/swagger-cli @mermaid-js/mermaid-cli

      - name: Markdown lint
        run: markdownlint-cli2 "**/*.md"

      - name: Vale prose lint
        uses: errata-ai/vale-action@v2.1.1
        with:
          files: docs
          fail_on_error: true

      - name: Generate quarterly audit report
        id: audit
        continue-on-error: true
        run: python3 scripts/docs/validate_docs.py audit-report --output .artifacts/docs-audit.json

      - name: MkDocs build
        if: always()
        continue-on-error: true
        run: mkdocs build --strict

      - name: Upload audit artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-audit-report
          path: .artifacts/docs-audit.json
          if-no-files-found: warn

      - name: Fail if audit validation failed
        if: steps.audit.outcome == 'failure'
        run: exit 1
